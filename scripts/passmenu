#!/usr/bin/env bash
shopt -s nullglob globstar

prefix=${PASSWORD_STORE_DIR-~/.password-store}

# build relative entry list
mapfile -t files < <(cd "$prefix" && printf '%s\n' **/*.gpg)
for i in "${!files[@]}"; do
    files[$i]=${files[$i]%.gpg}
done

choice=$(printf '%s\n' "${files[@]}" | dmenu -i -l 20 -fn "JetBrainsMono Nerd Font Bold:size=11" -p "pass:" "$@")
[[ -n $choice ]] || exit

if [[ "$choice" == */otp ]]; then
    ~/Projects/dotfiles/scripts/mfa.sh "$(pass show "$choice")"
    notify-send "pass" "Copied $choice to clipboard"
    exit
fi

# try to copy silently; if it fails, open st so user can interact
if pass show -c "$choice" >/dev/null 2>&1; then
    notify-send "pass" "Copied $choice to clipboard"
else
    st -e pass show -c "$choice"
fi

